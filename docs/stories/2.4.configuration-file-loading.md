# Story 2.4: Implement Configuration File Loading and Editing

**Status**: Ready

---

## Story

**As a** User,
**I want** to load and edit my existing configurations in the web UI,
**so that** I can easily modify or review past experiment setups.

---

## Acceptance Criteria

1. The "Experiment Configuration" page features a dropdown menu that lists all existing `.yaml` files in the `configs/` directory
2. Selecting a file from the dropdown automatically populates the form fields with the values from that file
3. Submitting the form after loading an existing configuration overwrites the original file with the updated values

---

## Tasks / Subtasks

- [ ] **Task 1: Implement Config File Scanner** (AC: 1)
  - [ ] Create function to scan configs/ directory
  - [ ] Return list of .yaml files
  - [ ] Handle empty directory case
  - [ ] Sort files alphabetically

- [ ] **Task 2: Add Dropdown Widget** (AC: 1)
  - [ ] Add st.selectbox above form
  - [ ] Populate with scanned config files
  - [ ] Add "Create New" option
  - [ ] Handle selection changes

- [ ] **Task 3: Implement Config Loading** (AC: 2)
  - [ ] Create function to load YAML file
  - [ ] Parse config into dict
  - [ ] Handle YAML parsing errors
  - [ ] Validate loaded config structure

- [ ] **Task 4: Populate Form from Loaded Config** (AC: 2)
  - [ ] Update form widgets with loaded values
  - [ ] Use Streamlit session state for persistence
  - [ ] Handle missing fields gracefully
  - [ ] Trigger form update on file selection

- [ ] **Task 5: Implement Overwrite Logic** (AC: 3)
  - [ ] Detect if editing existing config
  - [ ] Overwrite file on save
  - [ ] Show warning before overwrite
  - [ ] Update success message

- [ ] **Task 6: Testing** (AC: 1, 2, 3)
  - [ ] Test dropdown lists all configs
  - [ ] Test loading populates form
  - [ ] Test overwrite updates file
  - [ ] Test error handling

---

## Dev Notes

### Previous Story Insights
From Story 2.3:
- Save function implemented
- Files saved to configs/ directory
- YAML format validated

### Implementation Details

**Add to top of pages/1_üß™_experiment_configuration.py**:

```python
import streamlit as st
import yaml
from pathlib import Path
import re

# Function to scan for config files
def get_config_files() -> list[str]:
    """Scan configs/ directory for YAML files."""
    configs_dir = Path("configs")
    if not configs_dir.exists():
        return []
    
    yaml_files = list(configs_dir.glob("*.yaml"))
    return sorted([f.name for f in yaml_files])

# Function to load config file
def load_config_file(filename: str) -> dict:
    """Load YAML config file."""
    try:
        with open(f"configs/{filename}", 'r', encoding='utf-8') as f:
            return yaml.safe_load(f)
    except Exception as e:
        st.error(f"Error loading config: {e}")
        return None

st.title("üß™ Experiment Configuration")

# Config file selector
st.subheader("Load Existing Configuration")
config_files = get_config_files()

if config_files:
    selected_option = st.selectbox(
        "Select Configuration",
        options=["Create New Configuration"] + config_files,
        index=0
    )
    
    # Load selected config
    if selected_option != "Create New Configuration":
        loaded_config = load_config_file(selected_option)
        if loaded_config:
            st.info(f"üìÇ Loaded: `{selected_option}`")
            
            # Store in session state
            if 'loaded_config' not in st.session_state or st.session_state.get('current_file') != selected_option:
                st.session_state.loaded_config = loaded_config
                st.session_state.current_file = selected_option
                st.rerun()
else:
    st.info("No saved configurations found. Create a new one below.")

st.divider()

# Configuration Form with loaded values
with st.form("config_form"):
    st.subheader("Configuration Parameters")
    
    # Get values from loaded config or use defaults
    if 'loaded_config' in st.session_state:
        config = st.session_state.loaded_config
        default_run_id = config.get('run_id', '')
        default_model = config.get('model_name', 'llama3:latest')
        default_cycles = config.get('cycle_count', 10)
        default_host = config.get('ollama_client_config', {}).get('host', 'http://localhost:11434')
        model_opts = config.get('model_options', {})
        default_temp = model_opts.get('temperature', 0.7)
        default_top_p = model_opts.get('top_p', 0.9)
        default_num_predict = model_opts.get('num_predict', 2048)
        default_seed_value = model_opts.get('seed', 42)
        has_seed = 'seed' in model_opts
    else:
        default_run_id = ''
        default_model = 'llama3:latest'
        default_cycles = 10
        default_host = 'http://localhost:11434'
        default_temp = 0.7
        default_top_p = 0.9
        default_num_predict = 2048
        default_seed_value = 42
        has_seed = False
    
    # Form widgets with defaults
    col1, col2 = st.columns(2)
    with col1:
        run_id = st.text_input("Run ID *", value=default_run_id)
    with col2:
        model_name = st.text_input("Model Name *", value=default_model)
    
    # ... rest of form widgets with loaded defaults ...
    
    submitted = st.form_submit_button("Save Configuration")
    
    if submitted:
        # Validation and save logic (same as Story 2.3)
        # If editing existing file, overwrite it
        if 'current_file' in st.session_state:
            st.warning(f"‚ö†Ô∏è This will overwrite `{st.session_state.current_file}`")
        
        # Save configuration...
```

### Session State Management

**Key Session State Variables**:
- `st.session_state.loaded_config`: Currently loaded config dict
- `st.session_state.current_file`: Name of loaded file
- Clear on "Create New Configuration" selection

### File Locations
- **Config Page**: `pages/1_üß™_experiment_configuration.py`

---

## Testing

### Testing Requirements for Story 2.4

**Manual Testing Checklist**:

1. **test_dropdown_lists_configs**
   - Create 3 config files manually
   - Navigate to Config page
   - Verify dropdown shows all 3 files
   - Verify "Create New Configuration" option present

2. **test_load_config_populates_form**
   - Select a saved config from dropdown
   - Verify all form fields populate correctly
   - Check run_id, model_name, cycle_count match file
   - Verify advanced options load

3. **test_overwrite_existing_config**
   - Load existing config
   - Change cycle_count value
   - Save configuration
   - Reload file
   - Verify changes persisted

4. **test_create_new_after_loading**
   - Load existing config
   - Select "Create New Configuration"
   - Verify form resets to defaults
   - Fill new values and save
   - Verify new file created

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 1.0 | Initial story creation | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used
*To be populated by dev agent during implementation*

### Debug Log References
*To be populated by dev agent during implementation*

### Completion Notes List
*To be populated by dev agent during implementation*

### File List
*To be populated by dev agent during implementation*

---

## QA Results
*To be populated by QA agent after implementation*
