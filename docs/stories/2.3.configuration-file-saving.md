# Story 2.3: Implement Configuration File Saving

**Status**: Ready

---

## Story

**As a** User,
**I want** to save the configuration I create in the form to a file,
**so that** the experiment runner can use it.

---

## Acceptance Criteria

1. The form contains a "Save Configuration" submit button
2. Upon submission, a new `.yaml` file is created in a `configs/` directory
3. The name of the file is based on the `run_id` (e.g., `configs/MyRun-A.yaml`)
4. The content of the generated file is valid YAML and accurately reflects all values entered in the form
5. If file save fails (e.g., permissions error, disk full), a clear error message is displayed to the user
6. On successful save, a success message confirms the file was saved with its path

---

## Tasks / Subtasks

- [ ] **Task 1: Implement YAML File Saving Function** (AC: 2, 3, 4)
  - [ ] Create function to save config dict as YAML
  - [ ] Generate filename from run_id (sanitize for filesystem)
  - [ ] Ensure configs/ directory exists
  - [ ] Write YAML to file with proper formatting
  - [ ] Add function docstring

- [ ] **Task 2: Update Form Submission Handler** (AC: 1, 4, 6)
  - [ ] Update config form in pages/1_üß™_experiment_configuration.py
  - [ ] Call save function on successful validation
  - [ ] Display success message with file path
  - [ ] Show download link for saved file (optional)

- [ ] **Task 3: Implement Error Handling** (AC: 5)
  - [ ] Wrap file save in try-except
  - [ ] Handle PermissionError
  - [ ] Handle OSError (disk full, path issues)
  - [ ] Display clear error messages with st.error()

- [ ] **Task 4: Filename Sanitization** (AC: 3)
  - [ ] Remove/replace invalid filesystem characters
  - [ ] Handle spaces (convert to hyphens or underscores)
  - [ ] Ensure filename is valid on Windows/Linux/Mac
  - [ ] Add .yaml extension if not present

- [ ] **Task 5: YAML Formatting** (AC: 4)
  - [ ] Use PyYAML with proper settings
  - [ ] Ensure consistent indentation
  - [ ] Add comments for clarity (optional)
  - [ ] Verify output is valid YAML

- [ ] **Task 6: Testing** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Test successful save
  - [ ] Test file created in correct location
  - [ ] Test YAML content is valid
  - [ ] Test error handling (permissions)
  - [ ] Test filename sanitization

---

## Dev Notes

### Previous Story Insights
From Story 2.2:
- Form validation complete with config_data dict
- All form widgets implemented
- Validation logic working

### Implementation Details

**Update pages/1_üß™_experiment_configuration.py**:

```python
import streamlit as st
import yaml
from pathlib import Path
import re

# Helper function for filename sanitization
def sanitize_filename(run_id: str) -> str:
    """
    Sanitize run_id for use as filename.
    
    Args:
        run_id: Run identifier from form
        
    Returns:
        Sanitized filename safe for all filesystems
        
    Example:
        >>> sanitize_filename("My Run #1")
        'My-Run-1'
    """
    # Replace spaces with hyphens
    filename = run_id.replace(' ', '-')
    
    # Remove invalid filesystem characters
    filename = re.sub(r'[<>:"/\\|?*]', '', filename)
    
    # Remove any other non-alphanumeric except hyphens and underscores
    filename = re.sub(r'[^a-zA-Z0-9_-]', '', filename)
    
    # Ensure not empty
    if not filename:
        filename = "config"
    
    return filename

# Helper function for saving YAML
def save_config_to_yaml(config_data: dict, run_id: str) -> tuple[bool, str]:
    """
    Save configuration dictionary to YAML file.
    
    Args:
        config_data: Configuration dictionary
        run_id: Run identifier for filename
        
    Returns:
        Tuple of (success: bool, message: str)
        
    Creates configs/ directory if it doesn't exist.
    Saves file as configs/{sanitized_run_id}.yaml
    """
    try:
        # Ensure configs directory exists
        configs_dir = Path("configs")
        configs_dir.mkdir(exist_ok=True)
        
        # Sanitize filename
        filename = sanitize_filename(run_id)
        
        # Add .yaml extension if not present
        if not filename.endswith('.yaml'):
            filename += '.yaml'
        
        # Full file path
        file_path = configs_dir / filename
        
        # Write YAML file
        with open(file_path, 'w', encoding='utf-8') as f:
            yaml.dump(
                config_data,
                f,
                default_flow_style=False,  # Use block style (more readable)
                sort_keys=False,            # Preserve key order
                allow_unicode=True,
                indent=2
            )
        
        return True, str(file_path)
        
    except PermissionError:
        return False, f"Permission denied: Cannot write to configs/ directory. Check file permissions."
    except OSError as e:
        if "No space left on device" in str(e):
            return False, "Disk full: Not enough space to save configuration file."
        else:
            return False, f"File system error: {str(e)}"
    except Exception as e:
        return False, f"Unexpected error saving configuration: {str(e)}"

# [Previous form code...]

# Form submission handler (updated)
if submitted:
    # Validation
    errors = []
    
    if not run_id or run_id.strip() == "":
        errors.append("Run ID cannot be empty")
    
    if cycle_count <= 0:
        errors.append("Cycle count must be greater than 0")
    
    if temperature < 0.0 or temperature > 2.0:
        errors.append("Temperature must be between 0.0 and 2.0")
    
    if top_p < 0.0 or top_p > 1.0:
        errors.append("Top P must be between 0.0 and 1.0")
    
    if errors:
        for error in errors:
            st.error(f"‚ùå {error}")
    else:
        # Build configuration dict
        config_data = {
            "run_id": run_id.strip(),
            "model_name": model_name.strip(),
            "cycle_count": cycle_count,
            "ollama_client_config": {
                "host": ollama_host.strip()
            },
            "model_options": {
                "temperature": temperature,
                "top_p": top_p,
                "num_predict": num_predict
            }
        }
        
        # Add optional seed if checkbox is checked
        if use_seed:
            config_data["model_options"]["seed"] = seed
        
        # Add advanced options if different from defaults
        if repeat_last_n != 64:
            config_data["model_options"]["repeat_last_n"] = repeat_last_n
        if repeat_penalty != 1.1:
            config_data["model_options"]["repeat_penalty"] = repeat_penalty
        if num_ctx != 4096:
            config_data["model_options"]["num_ctx"] = num_ctx
        
        # Save to YAML file
        success, message = save_config_to_yaml(config_data, run_id.strip())
        
        if success:
            st.success(f"‚úÖ Configuration saved successfully!")
            st.info(f"üìÅ File saved to: `{message}`")
            
            # Provide next steps
            st.markdown(f"""
            ### Next Steps
            
            To run this experiment, use the following command:
            ```bash
            python scripts/run_experiment.py --config {message}
            ```
            """)
            
            # Preview configuration
            with st.expander("Preview Saved Configuration"):
                st.json(config_data)
        else:
            st.error(f"‚ùå Failed to save configuration: {message}")

st.divider()
st.caption("üí° Tip: Configuration files are saved in the `configs/` directory")
```

### Filename Sanitization Rules

**Invalid Characters to Remove**:
- Windows reserved: `< > : " / \ | ? *`
- Control characters
- Leading/trailing dots

**Character Replacements**:
- Spaces ‚Üí Hyphens (or underscores)
- Multiple consecutive hyphens ‚Üí Single hyphen

**Edge Cases**:
```python
# Examples of sanitization
"My Experiment #1" ‚Üí "My-Experiment-1.yaml"
"GPT-4 Test: Run A" ‚Üí "GPT-4-Test-Run-A.yaml"
"experiment/config" ‚Üí "experimentconfig.yaml"
"  test  " ‚Üí "test.yaml"
"!!!" ‚Üí "config.yaml" (fallback)
```

### YAML Output Format

**Proper YAML Formatting**:
```yaml
run_id: llama3-exploration-001
model_name: llama3:latest
cycle_count: 10
ollama_client_config:
  host: http://localhost:11434
model_options:
  temperature: 0.7
  top_p: 0.9
  num_predict: 2048
  seed: 42
```

**PyYAML Settings**:
- `default_flow_style=False`: Use block style (not inline)
- `sort_keys=False`: Preserve insertion order
- `allow_unicode=True`: Handle non-ASCII characters
- `indent=2`: Use 2-space indentation

### Error Handling Scenarios

**Permission Error**:
```python
try:
    # Save file
except PermissionError:
    st.error("""
    ‚ùå Permission denied: Cannot write to configs/ directory.
    
    Possible solutions:
    - Check file permissions
    - Run app with appropriate permissions
    - Choose a different save location
    """)
```

**Disk Full**:
```python
except OSError as e:
    if "No space left on device" in str(e):
        st.error("‚ùå Disk full: Not enough space to save configuration file.")
```

**Invalid Path**:
```python
except Exception as e:
    st.error(f"‚ùå Unexpected error: {str(e)}")
```

### File Locations
**Source**: [docs/architecture/unified-project-structure.md]

Files to update:
- **Config Page**: `pages/1_üß™_experiment_configuration.py`

Directories:
- **Configs Directory**: `configs/` (created if doesn't exist)

### Success Message Design

**Clear Feedback**:
```python
st.success("‚úÖ Configuration saved successfully!")
st.info(f"üìÅ File saved to: `{file_path}`")

# Actionable next steps
st.markdown(f"""
### Next Steps

1. **Run Experiment**:
   ```bash
   python scripts/run_experiment.py --config {file_path}
   ```

2. **View Results**: After running, check the Results Dashboard

3. **Edit Configuration**: Reload this file using the dropdown above (Story 2.4)
""")
```

### Optional Enhancements

**Download Button** (optional):
```python
if success:
    # Read the saved file
    with open(file_path, 'r') as f:
        yaml_content = f.read()
    
    # Provide download button
    st.download_button(
        label="üì• Download Configuration",
        data=yaml_content,
        file_name=Path(file_path).name,
        mime="application/x-yaml"
    )
```

---

## Testing

### Test Standards for This Story
- **Manual Testing**: Primary method
- **File System Testing**: Verify actual file creation
- **YAML Validation**: Verify content is valid

### Testing Requirements for Story 2.3

**Manual Testing Checklist**:

1. **test_successful_file_save**
   - Fill form with run_id "test-experiment-001"
   - Click "Save Configuration"
   - Verify success message appears
   - Check file exists at `configs/test-experiment-001.yaml`
   - Open file and verify it's valid YAML

2. **test_yaml_content_accuracy**
   - Fill form with specific values:
     - run_id: "accuracy-test"
     - model_name: "llama3:latest"
     - cycle_count: 5
     - temperature: 0.8
     - seed: 123 (checked)
   - Save configuration
   - Open `configs/accuracy-test.yaml`
   - Verify all values match form input
   - Verify YAML structure is correct

3. **test_filename_sanitization_spaces**
   - Set run_id to "My Test Experiment"
   - Save configuration
   - Verify filename is "My-Test-Experiment.yaml"
   - Verify file exists

4. **test_filename_sanitization_special_chars**
   - Set run_id to "Exp#1: Test/Run"
   - Save configuration
   - Verify filename is sanitized (e.g., "Exp1-TestRun.yaml")
   - Verify file exists

5. **test_configs_directory_creation**
   - Delete `configs/` directory if exists
   - Fill form and save
   - Verify `configs/` directory is created
   - Verify file is saved inside it

6. **test_yaml_extension_added**
   - Set run_id to "test-no-ext"
   - Save configuration
   - Verify filename is "test-no-ext.yaml" (not just "test-no-ext")

7. **test_permission_error_handling**
   - Make `configs/` directory read-only
   - Try to save configuration
   - Verify error message displays
   - Verify error mentions permissions
   - Restore directory permissions

8. **test_empty_run_id_sanitization**
   - Set run_id to "!!!" (all invalid characters)
   - Save configuration
   - Verify fallback filename used (e.g., "config.yaml")
   - OR verify validation prevents save

9. **test_overwrite_existing_file**
   - Create config with run_id "test-overwrite"
   - Save successfully
   - Change cycle_count to different value
   - Save again with same run_id
   - Verify file is overwritten (not appended)
   - Verify new value is in file

10. **test_success_message_shows_path**
    - Save any configuration
    - Verify success message includes full file path
    - Verify path is displayed clearly (e.g., in code block)

11. **test_next_steps_cli_command**
    - Save configuration
    - Verify "Next Steps" section appears
    - Verify CLI command shown matches saved file path
    - Verify command is copy-pasteable

12. **test_configuration_preview**
    - Save configuration
    - Expand "Preview Saved Configuration"
    - Verify JSON preview matches YAML file content
    - Check all fields present

**File System Tests**:

1. **test_yaml_is_valid**
   - Save configuration
   - Use PyYAML to load the saved file:
     ```python
     import yaml
     with open('configs/test.yaml', 'r') as f:
         data = yaml.safe_load(f)
     assert data is not None
     ```

2. **test_file_is_readable**
   - Save configuration
   - Open file in text editor
   - Verify human-readable format
   - Check indentation is consistent
   - Verify no syntax errors

**Edge Cases**:

- Very long run_id (200+ characters)
- Unicode characters in run_id (e.g., "ÂÆüÈ®ì-1")
- run_id with only spaces
- Simultaneous saves (race condition test)
- Network drive locations (if applicable)

**Browser Compatibility**:
- Test in Chrome, Firefox, Edge
- Verify download button works (if implemented)
- Check file save works across browsers

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 1.0 | Initial story creation | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used
*To be populated by dev agent during implementation*

### Debug Log References
*To be populated by dev agent during implementation*

### Completion Notes List
*To be populated by dev agent during implementation*

### File List
*To be populated by dev agent during implementation*

---

## QA Results
*To be populated by QA agent after implementation*
