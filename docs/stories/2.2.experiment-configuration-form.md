# Story 2.2: Implement Experiment Configuration Form

**Status**: Ready

---

## Story

**As a** User,
**I want** a form in the web UI to define all parameters for an experiment,
**so that** I don't have to write YAML manually.

---

## Acceptance Criteria

1. The "Experiment Configuration" page displays a form implemented with `st.form`
2. The form includes widgets for all required parameters: `run_id`, `model_name`, `cycle_count`, and all `model_options` (e.g., `temperature`, `seed`, etc.)
3. Appropriate Streamlit input widgets (e.g., `st.text_input`, `st.number_input`) are used for each parameter
4. Form validation ensures `cycle_count` is a positive integer greater than 0
5. Form validation ensures `run_id` is not empty
6. Invalid input displays a clear error message using `st.error` or `st.warning`

---

## Tasks / Subtasks

- [ ] **Task 1: Update Configuration Page with Form Structure** (AC: 1)
  - [ ] Update `pages/1_üß™_experiment_configuration.py`
  - [ ] Add `st.form` container with unique key
  - [ ] Add form submit button
  - [ ] Remove placeholder content from Story 2.1

- [ ] **Task 2: Add Basic Configuration Widgets** (AC: 2, 3)
  - [ ] Add `st.text_input` for run_id
  - [ ] Add `st.selectbox` or `st.text_input` for model_name
  - [ ] Add `st.number_input` for cycle_count
  - [ ] Use appropriate default values

- [ ] **Task 3: Add Model Options Widgets** (AC: 2, 3)
  - [ ] Add `st.number_input` for temperature (0.0-2.0)
  - [ ] Add `st.number_input` for top_p (0.0-1.0)
  - [ ] Add `st.number_input` for num_predict (-1 or positive int)
  - [ ] Add `st.number_input` for seed (optional)
  - [ ] Add other Ollama options as needed

- [ ] **Task 4: Implement Form Validation** (AC: 4, 5, 6)
  - [ ] Check run_id is not empty
  - [ ] Check cycle_count > 0
  - [ ] Validate temperature range (0.0-2.0)
  - [ ] Validate top_p range (0.0-1.0)
  - [ ] Display errors with st.error()

- [ ] **Task 5: Add Form Layout and Styling** (AC: 3)
  - [ ] Use st.columns() for better layout
  - [ ] Add section headers with st.subheader()
  - [ ] Add helpful tooltips and descriptions
  - [ ] Use expanders for advanced options

- [ ] **Task 6: Testing** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Test form displays correctly
  - [ ] Test all widgets accept input
  - [ ] Test validation catches invalid input
  - [ ] Test error messages display properly

---

## Dev Notes

### Previous Story Insights
From Story 2.1:
- Basic Streamlit app structure created
- Configuration page exists with placeholder content
- Navigation working correctly

### ExperimentConfig Schema
**Source**: [docs/architecture/data-models.md#experimentconfig]

Complete configuration structure:
```python
{
    "run_id": str,              # Unique identifier
    "model_name": str,          # Ollama model tag
    "cycle_count": int,         # Number of cycles (>0)
    "ollama_client_config": {
        "host": str             # Default: "http://localhost:11434"
    },
    "model_options": {
        "temperature": float,    # 0.0-2.0, default 0.7
        "top_p": float,         # 0.0-1.0, default 0.9
        "num_predict": int,     # -1 = unlimited, default 2048
        "seed": int             # Optional, for reproducibility
    }
}
```

### Implementation Details

**Complete Configuration Form**:

```python
import streamlit as st
from pathlib import Path

st.title("üß™ Experiment Configuration")

st.write("""
Configure your ContReAct-Ollama experiment parameters below. 
All fields marked with * are required.
""")

# Form for configuration
with st.form("config_form"):
    st.subheader("Basic Configuration")
    
    col1, col2 = st.columns(2)
    
    with col1:
        run_id = st.text_input(
            "Run ID *",
            value="",
            help="Unique identifier for this experiment run (e.g., 'llama3-exploration-001')",
            placeholder="my-experiment-001"
        )
    
    with col2:
        model_name = st.text_input(
            "Model Name *",
            value="llama3:latest",
            help="Ollama model tag (e.g., 'llama3:latest', 'mistral:7b')"
        )
    
    cycle_count = st.number_input(
        "Cycle Count *",
        min_value=1,
        max_value=100,
        value=10,
        step=1,
        help="Number of exploration cycles to run"
    )
    
    st.divider()
    st.subheader("Ollama Client Configuration")
    
    ollama_host = st.text_input(
        "Ollama Host",
        value="http://localhost:11434",
        help="URL of the Ollama server"
    )
    
    st.divider()
    st.subheader("Model Options")
    
    col1, col2 = st.columns(2)
    
    with col1:
        temperature = st.number_input(
            "Temperature",
            min_value=0.0,
            max_value=2.0,
            value=0.7,
            step=0.1,
            help="Controls randomness (0.0 = deterministic, 2.0 = very random)"
        )
        
        num_predict = st.number_input(
            "Max Tokens",
            min_value=-1,
            max_value=100000,
            value=2048,
            step=256,
            help="Maximum tokens to generate (-1 = unlimited)"
        )
    
    with col2:
        top_p = st.number_input(
            "Top P",
            min_value=0.0,
            max_value=1.0,
            value=0.9,
            step=0.05,
            help="Nucleus sampling threshold"
        )
        
        use_seed = st.checkbox("Set Random Seed", value=False)
        seed = st.number_input(
            "Seed",
            min_value=0,
            max_value=999999,
            value=42,
            disabled=not use_seed,
            help="Random seed for reproducibility"
        )
    
    # Advanced options in expander
    with st.expander("Advanced Model Options"):
        repeat_last_n = st.number_input(
            "Repeat Last N",
            min_value=-1,
            max_value=256,
            value=64,
            help="How far back model looks to prevent repetition"
        )
        
        repeat_penalty = st.number_input(
            "Repeat Penalty",
            min_value=0.0,
            max_value=2.0,
            value=1.1,
            step=0.1,
            help="How strongly to penalize repetitions"
        )
        
        num_ctx = st.number_input(
            "Context Window Size",
            min_value=512,
            max_value=32768,
            value=4096,
            step=512,
            help="Context window size for the model"
        )
    
    st.divider()
    
    # Submit button
    submitted = st.form_submit_button(
        "Save Configuration",
        type="primary",
        use_container_width=True
    )
    
    # Form validation and processing
    if submitted:
        # Validation
        errors = []
        
        if not run_id or run_id.strip() == "":
            errors.append("Run ID cannot be empty")
        
        if cycle_count <= 0:
            errors.append("Cycle count must be greater than 0")
        
        if temperature < 0.0 or temperature > 2.0:
            errors.append("Temperature must be between 0.0 and 2.0")
        
        if top_p < 0.0 or top_p > 1.0:
            errors.append("Top P must be between 0.0 and 1.0")
        
        if errors:
            for error in errors:
                st.error(f"‚ùå {error}")
        else:
            # Build configuration dict (will be used in Story 2.3)
            config_data = {
                "run_id": run_id.strip(),
                "model_name": model_name.strip(),
                "cycle_count": cycle_count,
                "ollama_client_config": {
                    "host": ollama_host.strip()
                },
                "model_options": {
                    "temperature": temperature,
                    "top_p": top_p,
                    "num_predict": num_predict
                }
            }
            
            # Add optional seed if checkbox is checked
            if use_seed:
                config_data["model_options"]["seed"] = seed
            
            # Add advanced options if different from defaults
            if repeat_last_n != 64:
                config_data["model_options"]["repeat_last_n"] = repeat_last_n
            if repeat_penalty != 1.1:
                config_data["model_options"]["repeat_penalty"] = repeat_penalty
            if num_ctx != 4096:
                config_data["model_options"]["num_ctx"] = num_ctx
            
            st.success("‚úÖ Configuration validated successfully!")
            st.info("üíæ File saving will be implemented in Story 2.3")
            
            # Preview configuration
            with st.expander("Preview Configuration"):
                st.json(config_data)

st.divider()
st.caption("üí° Tip: Required fields are marked with *")
```

### Widget Selection Guidelines

**Source**: [docs/architecture/frontend-architecture.md]

| Parameter | Widget | Reason |
|-----------|--------|--------|
| run_id | st.text_input | Free-form text identifier |
| model_name | st.text_input | Ollama model tag (could be selectbox if we fetch available models) |
| cycle_count | st.number_input | Constrained integer with min/max |
| temperature | st.number_input | Float with specific range |
| top_p | st.number_input | Float with specific range |
| num_predict | st.number_input | Integer, can be -1 |
| seed | st.number_input + st.checkbox | Optional integer parameter |

### Validation Rules

**Required Field Validation**:
```python
# Run ID
if not run_id or run_id.strip() == "":
    st.error("Run ID cannot be empty")

# Cycle Count
if cycle_count <= 0:
    st.error("Cycle count must be greater than 0")
```

**Range Validation**:
```python
# Temperature: 0.0 - 2.0
if temperature < 0.0 or temperature > 2.0:
    st.error("Temperature must be between 0.0 and 2.0")

# Top P: 0.0 - 1.0
if top_p < 0.0 or top_p > 1.0:
    st.error("Top P must be between 0.0 and 1.0")
```

**Ollama Model Tag Format** (optional):
```python
# Pattern: name:tag or just name
import re
model_pattern = r'^[a-zA-Z0-9_-]+(:[a-zA-Z0-9_-]+)?$'
if not re.match(model_pattern, model_name):
    st.warning("Model name format may be invalid (expected: 'name:tag')")
```

### Form Layout Best Practices

**Two-Column Layout**:
```python
col1, col2 = st.columns(2)
with col1:
    # Left column widgets
    pass
with col2:
    # Right column widgets
    pass
```

**Section Organization**:
1. Basic Configuration (run_id, model, cycles)
2. Ollama Client Configuration (host)
3. Model Options (temperature, top_p, etc.)
4. Advanced Options (in expander)

**Help Text**:
- Use `help` parameter for all widgets
- Provide examples where helpful
- Explain ranges and defaults

### Error Display Strategy

**Validation Errors**:
```python
errors = []

# Collect all errors
if validation_fails:
    errors.append("Error message")

# Display all at once
if errors:
    for error in errors:
        st.error(f"‚ùå {error}")
else:
    st.success("‚úÖ Validation passed!")
```

**Warning vs Error**:
- `st.error()`: Critical validation failures
- `st.warning()`: Non-critical issues or suggestions
- `st.info()`: Helpful information
- `st.success()`: Successful validation/save

### File Locations
**Source**: [docs/architecture/unified-project-structure.md]

File to update:
- **Config Page**: `pages/1_üß™_experiment_configuration.py`

---

## Testing

### Test Standards for This Story
- **Manual Testing**: Primary method for UI verification
- **Test all input combinations**
- **Verify validation logic**

### Testing Requirements for Story 2.2

**Manual Testing Checklist**:

1. **test_form_displays_all_widgets**
   - Navigate to Experiment Configuration page
   - Verify all widgets appear
   - Check run_id, model_name, cycle_count visible
   - Check all model_options visible
   - Verify submit button present

2. **test_default_values**
   - Check run_id is empty by default
   - Check model_name defaults to "llama3:latest"
   - Check cycle_count defaults to 10
   - Check temperature defaults to 0.7
   - Check top_p defaults to 0.9
   - Check num_predict defaults to 2048

3. **test_run_id_required**
   - Leave run_id empty
   - Click "Save Configuration"
   - Verify error message appears
   - Check message says "Run ID cannot be empty"

4. **test_cycle_count_validation**
   - Set cycle_count to 0
   - Click "Save Configuration"
   - Verify error shows "Cycle count must be greater than 0"
   - Set cycle_count to -5
   - Verify error appears

5. **test_temperature_range_validation**
   - Set temperature to -0.5
   - Verify error or widget prevents invalid value
   - Set temperature to 2.5
   - Verify error or widget prevents invalid value
   - Set temperature to 1.0
   - Verify no error

6. **test_top_p_range_validation**
   - Set top_p to -0.1
   - Verify error or widget prevents invalid value
   - Set top_p to 1.5
   - Verify error or widget prevents invalid value
   - Set top_p to 0.8
   - Verify no error

7. **test_valid_configuration**
   - Fill run_id with "test-experiment"
   - Set model_name to "llama3:latest"
   - Set cycle_count to 5
   - Leave other fields as default
   - Click "Save Configuration"
   - Verify success message appears
   - Verify "Configuration validated successfully!"

8. **test_optional_seed**
   - Uncheck "Set Random Seed"
   - Verify seed input is disabled
   - Check "Set Random Seed"
   - Verify seed input is enabled
   - Verify seed value is included when checked

9. **test_advanced_options_expander**
   - Click "Advanced Model Options" expander
   - Verify it opens
   - Check repeat_last_n, repeat_penalty, num_ctx visible
   - Verify they have default values

10. **test_form_layout**
    - Verify two-column layout for some fields
    - Check sections are clearly separated with dividers
    - Verify expander for advanced options works
    - Check all help text tooltips work

11. **test_multiple_errors_display**
    - Leave run_id empty
    - Set cycle_count to 0
    - Click "Save Configuration"
    - Verify both errors display
    - Verify errors are clearly formatted

12. **test_configuration_preview**
    - Fill all required fields
    - Click "Save Configuration"
    - Expand "Preview Configuration"
    - Verify JSON structure matches input
    - Check all fields present

**Browser Compatibility**:
- Test in Chrome, Firefox, Edge
- Verify number inputs work correctly
- Check expanders work in all browsers

**Edge Cases**:
- Very long run_id (100+ characters)
- Special characters in run_id
- Decimal values in cycle_count (should only allow integers)
- Very large cycle_count (1000+)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 1.0 | Initial story creation | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used
*To be populated by dev agent during implementation*

### Debug Log References
*To be populated by dev agent during implementation*

### Completion Notes List
*To be populated by dev agent during implementation*

### File List
*To be populated by dev agent during implementation*

---

## QA Results
*To be populated by QA agent after implementation*
